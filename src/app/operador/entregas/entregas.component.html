<div class="p-4 sm:p-6 max-w-full sm:max-w-5xl mx-auto">
  <h1 class="text-2xl sm:text-3xl font-bold mb-4 sm:mb-6" style="color: var(--color-foreground)">Entregas Asignadas</h1>

  <!-- Filtros -->
  <div class="mb-4 flex flex-col sm:flex-row gap-3">
    <select [(ngModel)]="filtroEstado" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: var(--color-secondary); background-color: var(--color-bg)">
      <option value="">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="en proceso">En proceso</option>
      <option value="completada">Completada</option>
    </select>
    <input type="text" [(ngModel)]="searchText" placeholder="Buscar usuario o medicamento..." class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: var(--color-secondary); background-color: var(--color-bg)" />
  </div>

  <!-- Tabla responsiva -->
  <div class="bg-white rounded-lg shadow-md border" style="border-color: var(--color-secondary)">
    <!-- Vista de tabla en desktop -->
    <div class="hidden sm:block overflow-x-auto">
      <table class="min-w-[600px] w-full text-xs sm:text-sm">
        <thead>
          <tr class="border-b" style="background-color: var(--color-bg); border-color: var(--color-secondary)">
            <th class="px-2 sm:px-4 py-2 sm:py-3 text-left font-semibold" style="color: var(--color-foreground)">Usuario</th>
            <th class="px-2 sm:px-4 py-2 sm:py-3 text-left font-semibold" style="color: var(--color-foreground)">Dirección</th>
            <th class="px-2 sm:px-4 py-2 sm:py-3 text-left font-semibold" style="color: var(--color-foreground)">Fecha</th>
            <th class="px-2 sm:px-4 py-2 sm:py-3 text-left font-semibold" style="color: var(--color-foreground)">Hora</th>
            <th class="px-2 sm:px-4 py-2 sm:py-3 text-left font-semibold" style="color: var(--color-foreground)">Estado</th>
            <th class="px-2 sm:px-4 py-2 sm:py-3 text-left font-semibold" style="color: var(--color-foreground)">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let e of entregasFiltradas">
            <tr class="border-b cursor-pointer" style="border-color: var(--color-secondary)" (click)="toggleDetalle(e.id)">
              <td class="px-2 sm:px-4 py-2 sm:py-3" style="color: var(--color-foreground)">{{ e.usuario }}</td>
              <td class="px-2 sm:px-4 py-2 sm:py-3" style="color: var(--color-foreground)">{{ e.direccion }}</td>
              <td class="px-2 sm:px-4 py-2 sm:py-3" style="color: var(--color-foreground)">{{ e.fecha }}</td>
              <td class="px-2 sm:px-4 py-2 sm:py-3" style="color: var(--color-foreground)">{{ e.hora }}</td>
              <td class="px-2 sm:px-4 py-2 sm:py-3">
                <span *ngIf="e.estado === 'pendiente'" class="inline-block px-2 py-1 rounded text-xs font-medium" style="background-color: #F59E42; color: white">Pendiente</span>
                <span *ngIf="e.estado === 'en proceso'" class="inline-block px-2 py-1 rounded text-xs font-medium" style="background-color: var(--color-accent); color: white">En proceso</span>
                <span *ngIf="e.estado === 'completada'" class="inline-block px-2 py-1 rounded text-xs font-medium" style="background-color: #10B981; color: white">Completada</span>
              </td>
              <td class="px-2 sm:px-4 py-2 sm:py-3">
                <button *ngIf="e.estado !== 'completada'" (click)="$event.stopPropagation(); marcarCompletada(e)" class="px-3 py-1 rounded text-xs font-medium hover:opacity-80" style="background-color: var(--color-primary); color: white">Marcar completada</button>
              </td>
            </tr>
            <tr *ngIf="entregaAbierta === e.id">
              <td colspan="6" class="bg-gray-50 px-4 py-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <h3 class="font-semibold mb-2" style="color: var(--color-primary)">Medicamentos</h3>
                    <ul class="list-disc ml-4 mb-2">
                      <li *ngFor="let med of e.medicamentos" style="color: var(--color-foreground)">{{ med }}</li>
                    </ul>
                    <p class="text-sm mb-2" style="color: var(--color-foreground)"><strong>Observaciones:</strong> {{ e.observaciones || 'Ninguna' }}</p>
                  </div>
                  <div>
                    <h3 class="font-semibold mb-2" style="color: var(--color-primary)">Ubicación</h3>
                    <p class="text-sm mb-2" style="color: var(--color-foreground)"><strong>Dirección:</strong> {{ e.direccion }}</p>
                    <p class="text-sm mb-2" style="color: var(--color-foreground)"><strong>Distancia desde bodega:</strong> {{ getDistancia(e) }} km</p>
                    <!-- Mapa interactivo Leaflet -->
                    <div id="map-{{ e.id }}" class="w-full h-64 rounded border" style="border-color: var(--color-secondary)"></div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
    <!-- Vista de tarjetas en móvil -->
    <div class="block sm:hidden">
      <div *ngFor="let e of entregasFiltradas" class="mb-4 border rounded-lg shadow-sm overflow-hidden" style="border-color: var(--color-secondary); background-color: var(--color-bg)">
        <div class="p-4 flex flex-col gap-2" (click)="toggleDetalle(e.id)">
          <div class="flex justify-between items-center">
            <span class="font-semibold" style="color: var(--color-foreground)">{{ e.usuario }}</span>
            <span *ngIf="e.estado === 'pendiente'" class="inline-block px-2 py-1 rounded text-xs font-medium" style="background-color: #F59E42; color: white">Pendiente</span>
            <span *ngIf="e.estado === 'en proceso'" class="inline-block px-2 py-1 rounded text-xs font-medium" style="background-color: var(--color-accent); color: white">En proceso</span>
            <span *ngIf="e.estado === 'completada'" class="inline-block px-2 py-1 rounded text-xs font-medium" style="background-color: #10B981; color: white">Completada</span>
          </div>
          <div class="text-sm" style="color: var(--color-foreground)"><strong>Dirección:</strong> {{ e.direccion }}</div>
          <div class="text-sm" style="color: var(--color-foreground)"><strong>Fecha:</strong> {{ e.fecha }} <strong>Hora:</strong> {{ e.hora }}</div>
          <button *ngIf="e.estado !== 'completada'" (click)="$event.stopPropagation(); marcarCompletada(e)" class="mt-2 px-3 py-1 rounded text-xs font-medium hover:opacity-80" style="background-color: var(--color-primary); color: white">Marcar completada</button>
        </div>
        <div *ngIf="entregaAbierta === e.id" class="bg-gray-50 px-4 py-4">
          <div class="grid grid-cols-1 gap-4">
            <div>
              <h3 class="font-semibold mb-2" style="color: var(--color-primary)">Medicamentos</h3>
              <ul class="list-disc ml-4 mb-2">
                <li *ngFor="let med of e.medicamentos" style="color: var(--color-foreground)">{{ med }}</li>
              </ul>
              <p class="text-sm mb-2" style="color: var(--color-foreground)"><strong>Observaciones:</strong> {{ e.observaciones || 'Ninguna' }}</p>
            </div>
            <div>
              <h3 class="font-semibold mb-2" style="color: var(--color-primary)">Ubicación</h3>
              <p class="text-sm mb-2" style="color: var(--color-foreground)"><strong>Dirección:</strong> {{ e.direccion }}</p>
              <p class="text-sm mb-2" style="color: var(--color-foreground)"><strong>Distancia desde bodega:</strong> {{ getDistancia(e) }} km</p>
              <!-- Mapa interactivo Leaflet (móvil) -->
              <div id="map-mobile-{{ e.id }}" class="w-full h-64 rounded border" style="border-color: var(--color-secondary)"></div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="entregasFiltradas.length === 0" class="p-8 text-center" style="color: var(--color-foreground); opacity: 0.6">
        No hay entregas asignadas
      </div>
    </div>
  </div>
</div>
